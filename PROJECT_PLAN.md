# DuckDNS 自動更新プログラム - プロジェクト計画書

## 📊 プロジェクト概要

- **プロジェクト名**: DuckDNS 自動更新プログラム
- **開発言語**: Go 1.21+
- **目的**: グローバルIPアドレスを定期的に取得し、DuckDNSのDNSレコードを自動更新する
- **開始日**: 2026年1月10日
- **目標完了日**: 未定

---

## 🎯 フェーズ1: プロジェクト基盤セットアップ

### タスク1.1: ディレクトリ構造の作成
- [x] `cmd/duckdns/` ディレクトリ作成
- [x] `internal/config/` ディレクトリ作成
- [x] `internal/ip/` ディレクトリ作成
- [x] `internal/duckdns/` ディレクトリ作成
- [x] `internal/scheduler/` ディレクトリ作成
- [x] `deploy/` ディレクトリ作成

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 5分

---

### タスク1.2: go.mod の初期化
- [x] `go mod init` でモジュール初期化
- [x] モジュール名: `github.com/horitaku/duckdns`
- [x] Go バージョン指定: 1.25.5

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 5分

---

### タスク1.3: .gitignore の作成
- [x] Go言語用の.gitignore作成
- [x] 除外対象:
  - [x] バイナリファイル (`duckdns`)
  - [x] 設定ファイル (`config.yaml`)
  - [x] IDEファイル (`.idea/`, `.vscode/settings.json`)
  - [x] ビルド成果物

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 10分

---

## 🔧 フェーズ2: 設定管理パッケージの実装

### タスク2.1: 設定構造体の定義
- [x] `internal/config/config.go` ファイル作成
- [x] `Config` 構造体の定義
  - [x] DuckDNS設定 (domain, token)
  - [x] 更新間隔設定 (interval)
  - [x] IP取得ソース設定 (ip_sources)
  - [x] ログ設定 (level, format)

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 20分

---

### タスク2.2: YAML設定ファイル読み込み機能
- [x] `gopkg.in/yaml.v3` 依存追加
- [x] YAMLファイルからの読み込み関数実装
- [x] ファイルが存在しない場合のエラーハンドリング

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 30分

---

### タスク2.3: 環境変数からの設定読み込み
- [x] 環境変数の優先度実装
  - [x] `DUCKDNS_TOKEN` 環境変数
  - [x] `DUCKDNS_DOMAIN` 環境変数
  - [x] `DUCKDNS_INTERVAL` 環境変数
- [x] YAML設定と環境変数のマージロジック

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 30分

---

### タスク2.4: バリデーション機能
- [x] 必須項目チェック (domain, token)
- [x] interval のフォーマットチェック
- [x] IP取得ソースのURL検証
- [x] バリデーションエラーのわかりやすいメッセージ

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 30分

---

## 🌐 フェーズ3: グローバルIP取得機能の実装

### タスク3.1: IP Fetcher インターフェース定義
- [x] `internal/ip/fetcher.go` ファイル作成
- [x] `Fetcher` インターフェース定義
- [x] `Fetch(ctx context.Context) (string, error)` メソッド

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 15分

---

### タスク3.2: HTTPクライアントの実装
- [x] タイムアウト設定付きHTTPクライアント作成
- [x] デフォルトタイムアウト: 10秒
- [x] context.Context によるキャンセル対応

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 20分

---

### タスク3.3: 単一ソースからのIP取得実装
- [x] 指定URLからIPアドレス取得
- [x] レスポンスの解析とバリドーション
- [x] IPv4アドレスの正規表現チェック

**予定**: 2026年1月10日  
**実績**: 2026年1月10日 完了 ✅  
**所要時間見積**: 30分

---

### タスク3.4: フェイルオーバー機能の実装
- [x] 複数ソースの順次試行
- [x] 最初に成功したソースのIPを返す
- [x] すべて失敗時のエラー処理
- [x] 各試行のログ出力（slogによる構造化ログ）

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 40分

---

## 🦆 フェーズ4: DuckDNS APIクライアントの実装

### タスク4.1: Client 構造体の定義
- [x] `internal/duckdns/client.go` ファイル作成
- [x] `Client` 構造体定義
  - [x] HTTPクライアント（`HTTPDoer`インターフェース化）
  - [x] リトライ設定（最大回数・バックオフ）
  - [x] コンストラクタ（既定値適用）

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 15分

---

### タスク4.2: DuckDNS API 呼び出し実装
- [x] API URL構築: `https://www.duckdns.org/update`
- [x] クエリパラメータ設定 (domains, token, ip)
- [x] HTTPリクエスト送信
- [x] context.Context によるキャンセル対応
- [x] slog によるログ出力

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 30分

---

### タスク4.3: レスポンス解析
- [x] "OK" / "KO" の判定
- [x] 成功時のログ出力（slog.Info）
- [x] 失敗時のエラー生成（slog.Error）

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 20分

---

### タスク4.4: リトライロジックの実装
- [x] 指数バックオフアルゴリズム実装
- [x] 最大リトライ回数: 3回
- [x] バックオフ時間: 1秒, 2秒, 4秒
- [x] context.Context によるキャンセル対応
- [x] リトライ試行ログの出力

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 45分

---

## ⏰ フェーズ5: スケジューラーの実装

### タスク5.1: Scheduler 構造体の定義
- [x] `internal/scheduler/scheduler.go` ファイル作成
- [x] `Scheduler` 構造体定義
  - [x] 更新間隔
  - [x] IP Fetcher
  - [x] DuckDNS Client

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 15分

---

### タスク5.2: 定期実行ループの実装
- [x] `time.Ticker` を使った定期実行
- [x] `context.Context` による停止処理
- [x] select文での制御

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 30分

---

### タスク5.3: IP変更検知ロジック
- [x] 前回取得したIPの保存
- [x] 現在のIPとの比較
- [x] 変更がない場合はスキップ
- [x] 変更時のログ出力

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 30分

---

### タスク5.4: エラーハンドリングと継続処理
- [x] IP取得失敗時も継続
- [x] 更新失敗時も継続
- [x] エラーログの適切な出力
- [x] 次回実行タイミングの保証

**予定**: 未定  
**実績**: 2026年1月11日 完了 ✅  
**所要時間見積**: 30分

---

## 🚀 フェーズ6: メインプログラムの実装

### タスク6.1: コマンドライン引数の処理
- [ ] `cmd/duckdns/main.go` ファイル作成
- [ ] `-config` フラグの実装
- [ ] `-version` フラグの実装
- [ ] ヘルプメッセージの実装

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

### タスク6.2: ログの初期化
- [ ] `log/slog` の初期化
- [ ] ログレベルの設定
- [ ] ログフォーマット (JSON/テキスト) の選択
- [ ] 構造化ログの設定

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

### タスク6.3: シグナルハンドリング
- [ ] `os/signal` によるシグナル受信
- [ ] SIGINT (Ctrl+C) のハンドリング
- [ ] SIGTERM のハンドリング
- [ ] グレースフルシャットダウン

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

### タスク6.4: 各コンポーネントの統合
- [ ] Config の読み込み
- [ ] IP Fetcher の初期化
- [ ] DuckDNS Client の初期化
- [ ] Scheduler の初期化と実行
- [ ] エラーハンドリング

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 45分

---

## 📝 フェーズ7: 設定ファイルサンプルの作成

### タスク7.1: config.yaml.example の作成
- [ ] ファイル作成
- [ ] 各設定項目のコメント記載
- [ ] デフォルト値の設定
- [ ] 使用例の記載

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 20分

---

## 🔧 フェーズ8: デプロイ関連ファイルの作成

### タスク8.1: systemd サービスファイルの作成
- [ ] `deploy/duckdns.service` ファイル作成
- [ ] Unit セクションの記載
  - [ ] Description
  - [ ] After (ネットワーク依存)
  - [ ] Wants (ネットワーク依存)
- [ ] Service セクションの記載
  - [ ] Type=simple
  - [ ] ExecStart
  - [ ] Restart=always
  - [ ] RestartSec
- [ ] Install セクションの記載
  - [ ] WantedBy=multi-user.target

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

### タスク8.2: install.sh の作成
- [ ] シェバン行の記載
- [ ] エラー時の停止設定 (`set -e`)
- [ ] ビルド処理
- [ ] バイナリのコピー (`/usr/local/bin/`)
- [ ] 設定ファイルのコピー (`/etc/duckdns/`)
- [ ] サービスファイルのコピー
- [ ] systemctl daemon-reload
- [ ] systemctl enable
- [ ] systemctl start
- [ ] 成功メッセージ

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 40分

---

### タスク8.3: uninstall.sh の作成
- [ ] シェバン行の記載
- [ ] エラー時の停止設定
- [ ] systemctl stop
- [ ] systemctl disable
- [ ] サービスファイルの削除
- [ ] バイナリの削除
- [ ] 設定ファイルの削除確認
- [ ] systemctl daemon-reload
- [ ] 成功メッセージ

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

## 🧪 フェーズ9: ユニットテストの作成

### タスク9.1: config パッケージのテスト
- [ ] `internal/config/config_test.go` 作成
- [ ] YAML読み込みのテスト
- [ ] 環境変数読み込みのテスト
- [ ] バリデーションのテスト
- [ ] エラーケースのテスト

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 60分

---

### タスク9.2: ip パッケージのテスト
- [ ] `internal/ip/fetcher_test.go` 作成
- [ ] httptest を使ったモックサーバー
- [ ] IP取得成功のテスト
- [ ] タイムアウトのテスト
- [ ] フェイルオーバーのテスト
- [ ] エラーケースのテスト

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 90分

---

### タスク9.3: duckdns パッケージのテスト
- [ ] `internal/duckdns/client_test.go` 作成
- [ ] httptest を使ったモックサーバー
- [ ] 更新成功のテスト
- [ ] 更新失敗のテスト
- [ ] リトライのテスト
- [ ] エラーケースのテスト

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 90分

---

### タスク9.4: scheduler パッケージのテスト
- [ ] `internal/scheduler/scheduler_test.go` 作成
- [ ] モックの作成 (IP Fetcher, DuckDNS Client)
- [ ] 定期実行のテスト
- [ ] IP変更検知のテスト
- [ ] context キャンセルのテスト
- [ ] エラー継続のテスト

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 120分

---

### タスク9.5: テストカバレッジの確認
- [ ] `go test -cover ./...` 実行
- [ ] カバレッジ 80% 以上確認
- [ ] 不足箇所の追加テスト実装

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

## 📚 フェーズ10: ドキュメント整備

### タスク10.1: README.md の更新
- [ ] プロジェクト説明の記載
- [ ] 機能一覧の記載
- [ ] インストール手順
  - [ ] 前提条件
  - [ ] ビルド方法
  - [ ] インストールスクリプトの使い方
- [ ] 設定方法
  - [ ] 設定ファイルの説明
  - [ ] 環境変数の説明
- [ ] 使用方法
  - [ ] 手動実行
  - [ ] サービスとしての実行
- [ ] トラブルシューティング
  - [ ] よくある問題と解決方法
  - [ ] ログの確認方法
- [ ] ライセンス情報

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 90分

---

### タスク10.2: コードドキュメントの確認
- [ ] 公開関数への GoDoc コメント確認
- [ ] パッケージドキュメントの確認
- [ ] サンプルコードの追加 (必要に応じて)

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

## ✅ フェーズ11: 最終テストとリリース準備

### タスク11.1: 統合テスト
- [ ] ローカル環境での動作確認
- [ ] 設定ファイルでの起動確認
- [ ] 環境変数での起動確認
- [ ] IP変更時の動作確認
- [ ] エラー時の動作確認

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 60分

---

### タスク11.2: systemd サービスとしての動作確認
- [ ] install.sh の実行確認
- [ ] サービス起動確認
- [ ] ログ確認 (`journalctl -u duckdns -f`)
- [ ] 自動再起動の確認
- [ ] uninstall.sh の実行確認

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 45分

---

### タスク11.3: リリースノートの作成
- [ ] CHANGELOG.md の作成
- [ ] v1.0.0 の機能一覧
- [ ] 既知の問題の記載

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

## � フェーズ12: CI/CD とリリース自動化

### タスク12.1: .goreleaser.yaml の作成
- [ ] `.goreleaser.yaml` ファイル作成
- [ ] プロジェクト設定
  - [ ] ビルド設定 (複数プラットフォーム対応)
    - [ ] Linux (amd64, arm64, arm)
    - [ ] macOS (amd64, arm64)
    - [ ] Windows (amd64)
  - [ ] アーカイブ設定 (tar.gz, zip)
  - [ ] チェックサム生成
- [ ] リリースノート自動生成設定
- [ ] GitHub Releases への成果物アップロード設定

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 45分

---

### タスク12.2: GitHub Actions ワークフロー (テスト) の作成
- [ ] `.github/workflows/test.yml` ファイル作成
- [ ] トリガー設定
  - [ ] push (main ブランチ)
  - [ ] pull_request
- [ ] ジョブ設定
  - [ ] Go のセットアップ (複数バージョン対応)
  - [ ] 依存関係のインストール
  - [ ] `go test` の実行
  - [ ] テストカバレッジの取得
  - [ ] カバレッジレポートの生成
- [ ] リント実行 (golangci-lint)

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 60分

---

### タスク12.3: GitHub Actions ワークフロー (リリース) の作成
- [ ] `.github/workflows/release.yml` ファイル作成
- [ ] トリガー設定
  - [ ] タグプッシュ時 (`v*.*.*`)
- [ ] ジョブ設定
  - [ ] Go のセットアップ
  - [ ] GoReleaser のインストール
  - [ ] `goreleaser release` の実行
  - [ ] GitHub Token の設定
- [ ] リリース成果物の自動アップロード

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 45分

---

### タスク12.4: リリースプロセスのドキュメント化
- [ ] CONTRIBUTING.md の作成
  - [ ] 開発環境のセットアップ
  - [ ] テストの実行方法
  - [ ] リリース手順
    - [ ] バージョンタグの付け方
    - [ ] CHANGELOG の更新方法
    - [ ] タグのプッシュ方法
- [ ] README.md へのバッジ追加
  - [ ] GitHub Actions ステータスバッジ
  - [ ] Go バージョンバッジ
  - [ ] リリースバージョンバッジ

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 45分

---

### タスク12.5: ローカルでのテスト
- [ ] GoReleaser のローカルインストール
- [ ] `goreleaser build --snapshot --clean` でローカルビルドテスト
- [ ] 生成された成果物の動作確認
- [ ] 設定ファイルの調整

**予定**: 未定  
**実績**: 未完了  
**所要時間見積**: 30分

---

## �📈 進捗サマリー

| フェーズ | タスク数 | 完了数 | 進捗率 | 状態 |
|---------|---------|--------|--------|------|
| フェーズ1: 基盤セットアップ | 3 | 3 | 100% | ✅ 完了 |
| フェーズ2: 設定管理 | 4 | 4 | 100% | ✅ 完了 |
| フェーズ3: IP取得機能 | 4 | 4 | 100% | ✅ 完了 |
| フェーズ4: DuckDNS API | 4 | 4 | 100% | ✅ 完了 |
| フェーズ5: スケジューラー | 4 | 4 | 100% | ✅ 完了 |
| フェーズ6: メインプログラム | 4 | 0 | 0% | 未着手 |
| フェーズ7: 設定サンプル | 1 | 0 | 0% | 未着手 |
| フェーズ8: デプロイ | 3 | 0 | 0% | 未着手 |
| フェーズ9: テスト | 5 | 0 | 0% | 未着手 |
| フェーズ10: ドキュメント | 2 | 0 | 0% | 未着手 |
| フェーズ11: 最終確認 | 3 | 0 | 0% | 未着手 |
| フェーズ12: CI/CD | 5 | 0 | 0% | 未着手 |
| **合計** | **42** | **19** | **45.2%** | **進行中** |

---

## 📝 メモ・課題

### 決定事項
- Docker対応は不要（systemdのみ）
- テストカバレッジ目標: 80%以上
- Go バージョン: 1.21+
- CI/CD: GitHub Actions + GoReleaser を使用
- マルチプラットフォーム対応 (Linux, macOS, Windows)

### 残課題
- 実際のDuckDNS環境でのテスト方法の検討

### 参考資料
- [DuckDNS API仕様](https://www.duckdns.org/spec.jsp)
- [Go 1.21 リリースノート](https://go.dev/doc/go1.21)
- [systemd サービスユニット](https://www.freedesktop.org/software/systemd/man/systemd.service.html)
- [GoReleaser 公式ドキュメント](https://goreleaser.com/)
- [GitHub Actions 公式ドキュメント](https://docs.github.com/en/actions)

---

**最終更新日**: 2026年1月10日
